<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç™»å½• - äººè„¸è¯†åˆ«ç­¾åˆ°ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 0 20px;
        }

        .login-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .switch-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .switch-link a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 500;
        }

        .switch-link a:hover {
            text-decoration: underline;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .face-login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .face-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .face-login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-size: 14px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .face-preview {
            max-width: 150px;
            max-height: 150px;
            margin: 15px auto;
            border-radius: 8px;
            display: block;
            display: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="login-box">
        <div class="logo">
            <h1>äººè„¸è¯†åˆ«ç­¾åˆ°ç³»ç»Ÿ</h1>
            <p>å­¦ç”Ÿç™»å½•</p>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label for="stuId">å­¦å·</label>
                <input type="text" id="stuId" placeholder="è¯·è¾“å…¥å­¦å·" required autofocus>
            </div>

            <div class="form-group">
                <label for="passwd">å¯†ç </label>
                <input type="password" id="passwd" placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <span style="margin-left: 10px;">ç™»å½•ä¸­...</span>
            </div>

            <button type="submit" class="login-btn" id="submitBtn">å¯†ç ç™»å½•</button>
        </form>

        <div class="divider">æˆ–</div>

        <div id="faceLoginSection">
            <div class="form-group">
                <label for="faceImage">äººè„¸ç™»å½•</label>
                <div class="file-input" onclick="document.getElementById('faceImage').click()"
                     style="padding: 20px; border: 2px dashed #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer;">
                    ğŸ“ ç‚¹å‡»é€‰æ‹©äººè„¸ç…§ç‰‡
                </div>
                <input type="file" id="faceImage" accept="image/*" style="display: none;"
                       onchange="previewFaceImage(event)">
                <img id="facePreview" class="face-preview" alt="äººè„¸é¢„è§ˆ">
            </div>

            <button type="button" class="face-login-btn" onclick="faceLogin()" id="faceLoginBtn">
                äººè„¸è¯†åˆ«ç™»å½•
            </button>
        </div>

        <div id="errorMsg" class="error-message"></div>

        <div class="switch-link">
            æ•™å¸ˆç™»å½•ï¼Ÿ <a href="teacher-login.html">ç‚¹å‡»è¿™é‡Œ</a>
        </div>

        <div id="debugInfo" class="debug-info"></div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';
    let isLoggingIn = false;

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    window.onload = function() {
        console.log('=== å­¦ç”Ÿç™»å½•é¡µé¢åŠ è½½ ===');

        // æ¸…é™¤ä¹‹å‰çš„è°ƒè¯•ä¿¡æ¯
        localStorage.removeItem('student_debug_info');

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
        const role = localStorage.getItem('role');

        console.log('å½“å‰ç™»å½•çŠ¶æ€æ£€æŸ¥:');
        console.log('- token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.log('- userId:', userId);
        console.log('- role:', role);

        // å¦‚æœå·²ç™»å½•ä¸”æ˜¯å­¦ç”Ÿè§’è‰²ï¼Œç›´æ¥è·³è½¬åˆ°ä»ªè¡¨æ¿
        if (token && role === 'STUDENT' && userId) {
            console.log('æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œè·³è½¬åˆ°å­¦ç”Ÿä»ªè¡¨æ¿');
            showMessage('æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œæ­£åœ¨è·³è½¬...', 'info');
            setTimeout(() => {
                window.location.href = 'student-dashboard.html';
            }, 1000);
        }

        // è‡ªåŠ¨å¡«å……æµ‹è¯•è´¦å·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.getElementById('stuId').value = '2024b11011';
            document.getElementById('passwd').value = '111111';
            console.log('å·²å¡«å……æµ‹è¯•è´¦å·: 2024b11011 / 111111');
        }
    };

    // å¯†ç ç™»å½•è¡¨å•æäº¤
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (isLoggingIn) return;

        const stuId = document.getElementById('stuId').value.trim();
        const passwd = document.getElementById('passwd').value;

        // éªŒè¯è¾“å…¥
        if (!stuId) {
            showMessage('è¯·è¾“å…¥å­¦å·', 'error');
            document.getElementById('stuId').focus();
            return;
        }

        if (!passwd) {
            showMessage('è¯·è¾“å…¥å¯†ç ', 'error');
            document.getElementById('passwd').focus();
            return;
        }

        // å¼€å§‹ç™»å½•
        await performLogin({ stuId, passwd }, 'password');
    });

    // äººè„¸ç™»å½•
    async function faceLogin() {
        if (isLoggingIn) return;

        const faceImageInput = document.getElementById('faceImage');
        const faceImage = faceImageInput.files[0];

        if (!faceImage) {
            showMessage('è¯·å…ˆé€‰æ‹©äººè„¸ç…§ç‰‡', 'error');
            return;
        }

        await performLogin({ faceImage }, 'face');
    }

    // æ‰§è¡Œç™»å½•
    async function performLogin(credentials, loginType) {
        isLoggingIn = true;
        showLoading(true);
        clearMessages();

        try {
            console.log(`=== å¼€å§‹${loginType === 'password' ? 'å¯†ç ' : 'äººè„¸'}ç™»å½•è¯·æ±‚ ===`);

            // åˆ›å»ºFormData
            const formData = new FormData();

            if (loginType === 'password') {
                formData.append('stuId', credentials.stuId);
                formData.append('passwd', credentials.passwd);
                console.log('å­¦å·:', credentials.stuId);
                console.log('å¯†ç :', '***' + credentials.passwd.substring(credentials.passwd.length - 2));
            } else {
                formData.append('faceImage', credentials.faceImage);
                console.log('äººè„¸ç…§ç‰‡:', credentials.faceImage.name);
            }

            // å‘é€ç™»å½•è¯·æ±‚
            const endpoint = loginType === 'password' ? 'login' : 'face-login';
            console.log('å‘é€è¯·æ±‚åˆ°:', `${API_BASE}/student/auth/${endpoint}`);

            const response = await fetch(`${API_BASE}/student/auth/${endpoint}`, {
                method: 'POST',
                body: formData
            });

            console.log('å“åº”çŠ¶æ€:', response.status);

            // è·å–å“åº”æ•°æ®
            const result = await response.json();
            console.log('å“åº”æ•°æ®:', result);

            // ä¿å­˜è°ƒè¯•ä¿¡æ¯
            const debugInfo = {
                loginType: loginType,
                request: loginType === 'password' ?
                    { stuId: credentials.stuId, passwdLength: credentials.passwd.length } :
                    { faceImage: credentials.faceImage?.name },
                response: { status: response.status, data: result }
            };
            localStorage.setItem('student_debug_info', JSON.stringify(debugInfo, null, 2));

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
            if (response.status !== 200 || !result.success) {
                document.getElementById('debugInfo').innerHTML =
                    `<strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>
                        ç™»å½•æ–¹å¼: ${loginType === 'password' ? 'å¯†ç ç™»å½•' : 'äººè„¸ç™»å½•'}<br>
                        çŠ¶æ€ç : ${response.status}<br>
                        å®Œæ•´å“åº”: <pre>${JSON.stringify(result, null, 2)}</pre>`;
                document.getElementById('debugInfo').style.display = 'block';
            }

            // å¤„ç†ç™»å½•ç»“æœ
            if (!result.success) {
                showMessage(result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·ä¿¡æ¯', 'error');
                return;
            }

            // ç™»å½•æˆåŠŸ - è§£ææ•°æ®
            console.log('=== ç™»å½•æˆåŠŸï¼Œè§£æå“åº”æ•°æ® ===');

            // æŸ¥æ‰¾studentId
            let studentId = null;
            let studentName = null;

            // å°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µå
            if (result.studentId) {
                studentId = result.studentId;
                console.log('ä» studentId å­—æ®µè·å–:', studentId);
            } else if (result.userId) {
                studentId = result.userId;
                console.log('ä» userId å­—æ®µè·å–:', studentId);
            } else if (result.studentInfo && result.studentInfo.stuId) {
                studentId = result.studentInfo.stuId;
                console.log('ä» studentInfo.stuId è·å–:', studentId);
            } else if (result.stuId) {
                studentId = result.stuId;
                console.log('ä» stuId å­—æ®µè·å–:', studentId);
            }

            // æŸ¥æ‰¾studentName
            if (result.studentName) {
                studentName = result.studentName;
                console.log('ä» studentName å­—æ®µè·å–:', studentName);
            } else if (result.studentInfo && result.studentInfo.stuName) {
                studentName = result.studentInfo.stuName;
                console.log('ä» studentInfo.stuName è·å–:', studentName);
            } else if (result.username) {
                studentName = result.username;
                console.log('ä» username å­—æ®µè·å–:', studentName);
            } else if (result.stuName) {
                studentName = result.stuName;
                console.log('ä» stuName å­—æ®µè·å–:', studentName);
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°studentIdï¼Œå°è¯•ä»tokenè§£ç 
            if (!studentId && result.token) {
                try {
                    const payload = JSON.parse(atob(result.token.split('.')[1]));
                    studentId = payload.userId || payload.sub;
                    console.log('ä»JWT tokenè§£ç è·å–:', studentId);
                } catch (e) {
                    console.log('Tokenè§£ç å¤±è´¥:', e.message);
                }
            }

            // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–studentId
            if (!studentId) {
                console.error('é”™è¯¯ï¼šæ— æ³•ä»å“åº”ä¸­æ‰¾åˆ°studentIdï¼');
                console.log('å“åº”ä¸­çš„æ‰€æœ‰å­—æ®µ:', Object.keys(result));
                showMessage('ç™»å½•æˆåŠŸï¼Œä½†æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                return;
            }

            console.log('æœ€ç»ˆç¡®å®šçš„å­¦ç”Ÿä¿¡æ¯:');
            console.log('- studentId:', studentId);
            console.log('- studentName:', studentName);
            console.log('- role:', result.role);
            console.log('- token:', result.token.substring(0, 50) + '...');

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('token', result.token);
            localStorage.setItem('userId', studentId);
            localStorage.setItem('username', studentName || (loginType === 'password' ? credentials.stuId : 'å­¦ç”Ÿ'));
            localStorage.setItem('role', result.role || 'STUDENT');

            // éªŒè¯ä¿å­˜
            console.log('=== ä¿å­˜åˆ°localStorageçš„å€¼ ===');
            console.log('- token:', localStorage.getItem('token') ? 'å·²ä¿å­˜' : 'æœªä¿å­˜');
            console.log('- userId:', localStorage.getItem('userId'));
            console.log('- username:', localStorage.getItem('username'));
            console.log('- role:', localStorage.getItem('role'));

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showMessage(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${studentName || studentId}`, 'success');

            // å»¶è¿Ÿè·³è½¬ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                console.log('è·³è½¬åˆ°å­¦ç”Ÿä»ªè¡¨æ¿...');
                window.location.href = 'student-dashboard.html';
            }, 1500);

        } catch (error) {
            console.error('ç™»å½•å¼‚å¸¸:', error);
            showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');

            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            document.getElementById('debugInfo').innerHTML =
                `<strong>é”™è¯¯è¯¦æƒ…ï¼š</strong><br>
                    é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                    è¯·æ£€æŸ¥ï¼š<br>
                    1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (localhost:8080)<br>
                    2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                    3. APIåœ°å€æ˜¯å¦æ­£ç¡®: ${API_BASE}`;
            document.getElementById('debugInfo').style.display = 'block';
        } finally {
            isLoggingIn = false;
            showLoading(false);
        }
    }

    // å›¾ç‰‡é¢„è§ˆ
    function previewFaceImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('facePreview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
    function showLoading(show) {
        const loading = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');
        const faceLoginBtn = document.getElementById('faceLoginBtn');

        if (show) {
            loading.style.display = 'block';
            submitBtn.disabled = true;
            faceLoginBtn.disabled = true;
            submitBtn.textContent = 'ç™»å½•ä¸­...';
            faceLoginBtn.textContent = 'è¯†åˆ«ä¸­...';
        } else {
            loading.style.display = 'none';
            submitBtn.disabled = false;
            faceLoginBtn.disabled = false;
            submitBtn.textContent = 'å¯†ç ç™»å½•';
            faceLoginBtn.textContent = 'äººè„¸è¯†åˆ«ç™»å½•';
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type) {
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.textContent = message;
        errorMsg.className = 'error-message';

        if (type === 'error') {
            errorMsg.style.color = '#dc3545';
            errorMsg.style.background = '#f8d7da';
        } else if (type === 'success') {
            errorMsg.style.color = '#28a745';
            errorMsg.style.background = '#d4edda';
        } else if (type === 'info') {
            errorMsg.style.color = '#17a2b8';
            errorMsg.style.background = '#d1ecf1';
        }

        errorMsg.style.display = 'block';
    }

    // æ¸…ç©ºæ¶ˆæ¯
    function clearMessages() {
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('debugInfo').style.display = 'none';
    }

    // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
    document.getElementById('passwd').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }
    });
</script>
</body>
</html>