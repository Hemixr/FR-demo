<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师登录 - 人脸识别签到系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 0 20px;
        }

        .login-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .switch-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .switch-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .switch-link a:hover {
            text-decoration: underline;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="login-box">
        <div class="logo">
            <h1>人脸识别签到系统</h1>
            <p>教师登录</p>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label for="teachId">教师工号</label>
                <input type="text" id="teachId" placeholder="请输入教师工号" required autofocus>
            </div>

            <div class="form-group">
                <label for="passwd">密码</label>
                <input type="password" id="passwd" placeholder="请输入密码" required>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <span style="margin-left: 10px;">登录中...</span>
            </div>

            <button type="submit" class="login-btn" id="submitBtn">登录</button>

            <div id="errorMsg" class="error-message"></div>

            <div class="switch-link">
                学生登录？ <a href="student-login.html">点击这里</a>
            </div>
        </form>

        <div id="debugInfo" class="debug-info"></div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';
    let isLoggingIn = false;

    // 页面加载时检查是否已登录
    window.onload = function() {
        console.log('=== 教师登录页面加载 ===');

        // 清除之前的调试信息
        localStorage.removeItem('debug_info');

        // 检查是否已登录
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
        const role = localStorage.getItem('role');

        console.log('当前登录状态检查:');
        console.log('- token:', token ? '存在' : '不存在');
        console.log('- userId:', userId);
        console.log('- role:', role);

        // 如果已登录且是教师角色，直接跳转到仪表板
        if (token && role === 'TEACHER' && userId) {
            console.log('检测到已登录，跳转到教师仪表板');
            showMessage('检测到已登录，正在跳转...', 'info');
            setTimeout(() => {
                window.location.href = 'teacher-dashboard.html';
            }, 1000);
        }

        // 自动填充测试账号（开发环境）
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.getElementById('teachId').value = '1001';
            document.getElementById('passwd').value = '123456';
            console.log('已填充测试账号: 1001 / 123456');
        }
    };

    // 登录表单提交
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (isLoggingIn) return;

        const teachId = document.getElementById('teachId').value.trim();
        const passwd = document.getElementById('passwd').value;

        // 验证输入
        if (!teachId) {
            showMessage('请输入教师工号', 'error');
            document.getElementById('teachId').focus();
            return;
        }

        if (!passwd) {
            showMessage('请输入密码', 'error');
            document.getElementById('passwd').focus();
            return;
        }

        // 开始登录
        isLoggingIn = true;
        showLoading(true);
        clearMessages();

        try {
            console.log('=== 开始登录请求 ===');
            console.log('工号:', teachId);
            console.log('密码:', '***' + passwd.substring(passwd.length - 2));

            // 创建FormData
            const formData = new FormData();
            formData.append('teachId', teachId);
            formData.append('passwd', passwd);

            // 发送登录请求
            console.log('发送请求到:', `${API_BASE}/teacher/auth/login`);
            const response = await fetch(`${API_BASE}/teacher/auth/login`, {
                method: 'POST',
                body: formData
            });

            console.log('响应状态:', response.status);

            // 获取响应数据
            const result = await response.json();
            console.log('响应数据:', result);

            // 保存调试信息
            const debugInfo = {
                request: { teachId, passwdLength: passwd.length },
                response: { status: response.status, data: result }
            };
            localStorage.setItem('debug_info', JSON.stringify(debugInfo, null, 2));

            // 显示调试信息（开发环境）
            if (response.status !== 200 || !result.success) {
                document.getElementById('debugInfo').innerHTML =
                    `<strong>调试信息：</strong><br>
                        状态码: ${response.status}<br>
                        完整响应: <pre>${JSON.stringify(result, null, 2)}</pre>`;
                document.getElementById('debugInfo').style.display = 'block';
            }

            // 处理登录结果
            if (!result.success) {
                showMessage(result.message || '登录失败，请检查工号和密码', 'error');
                return;
            }

            // 登录成功 - 解析数据
            console.log('=== 登录成功，解析响应数据 ===');

            // 查找teacherId
            let teacherId = null;
            let teacherName = null;

            // 尝试多个可能的字段名
            if (result.teacherId) {
                teacherId = result.teacherId;
                console.log('从 teacherId 字段获取:', teacherId);
            } else if (result.userId) {
                teacherId = result.userId;
                console.log('从 userId 字段获取:', teacherId);
            } else if (result.teacherInfo && result.teacherInfo.teachId) {
                teacherId = result.teacherInfo.teachId;
                console.log('从 teacherInfo.teachId 获取:', teacherId);
            }

            // 查找teacherName
            if (result.teacherName) {
                teacherName = result.teacherName;
                console.log('从 teacherName 字段获取:', teacherName);
            } else if (result.teacherInfo && result.teacherInfo.teachName) {
                teacherName = result.teacherInfo.teachName;
                console.log('从 teacherInfo.teachName 获取:', teacherName);
            } else if (result.username) {
                teacherName = result.username;
                console.log('从 username 字段获取:', teacherName);
            }

            // 如果没有找到teacherId，尝试从token解码
            if (!teacherId && result.token) {
                try {
                    const payload = JSON.parse(atob(result.token.split('.')[1]));
                    teacherId = payload.userId || payload.sub;
                    console.log('从JWT token解码获取:', teacherId);
                } catch (e) {
                    console.log('Token解码失败:', e.message);
                }
            }

            // 检查是否成功获取teacherId
            if (!teacherId) {
                console.error('错误：无法从响应中找到teacherId！');
                console.log('响应中的所有字段:', Object.keys(result));
                showMessage('登录成功，但无法获取用户信息，请联系管理员', 'error');
                return;
            }

            console.log('最终确定的教师信息:');
            console.log('- teacherId:', teacherId);
            console.log('- teacherName:', teacherName);
            console.log('- role:', result.role);
            console.log('- token:', result.token.substring(0, 50) + '...');

            // 保存到localStorage
            localStorage.setItem('token', result.token);
            localStorage.setItem('userId', teacherId);
            localStorage.setItem('username', teacherName || teachId);
            localStorage.setItem('role', result.role || 'TEACHER');

            // 验证保存
            console.log('=== 保存到localStorage的值 ===');
            console.log('- token:', localStorage.getItem('token') ? '已保存' : '未保存');
            console.log('- userId:', localStorage.getItem('userId'));
            console.log('- username:', localStorage.getItem('username'));
            console.log('- role:', localStorage.getItem('role'));

            // 显示成功消息
            showMessage(`登录成功！欢迎 ${teacherName || teachId}`, 'success');

            // 延迟跳转，确保用户看到成功消息
            setTimeout(() => {
                console.log('跳转到教师仪表板...');
                window.location.href = 'teacher-dashboard.html';
            }, 1500);

        } catch (error) {
            console.error('登录异常:', error);
            showMessage('网络错误: ' + error.message, 'error');

            // 显示详细的错误信息
            document.getElementById('debugInfo').innerHTML =
                `<strong>错误详情：</strong><br>
                    错误信息: ${error.message}<br>
                    请检查：<br>
                    1. 后端服务是否启动 (localhost:8080)<br>
                    2. 网络连接是否正常<br>
                    3. API地址是否正确: ${API_BASE}`;
            document.getElementById('debugInfo').style.display = 'block';
        } finally {
            isLoggingIn = false;
            showLoading(false);
        }
    });

    // 显示/隐藏加载动画
    function showLoading(show) {
        const loading = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');

        if (show) {
            loading.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.textContent = '登录中...';
        } else {
            loading.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = '登录';
        }
    }

    // 显示消息
    function showMessage(message, type) {
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.textContent = message;
        errorMsg.className = 'error-message';

        if (type === 'error') {
            errorMsg.style.color = '#dc3545';
            errorMsg.style.background = '#f8d7da';
        } else if (type === 'success') {
            errorMsg.style.color = '#28a745';
            errorMsg.style.background = '#d4edda';
        } else if (type === 'info') {
            errorMsg.style.color = '#17a2b8';
            errorMsg.style.background = '#d1ecf1';
        }

        errorMsg.style.display = 'block';
    }

    // 清空消息
    function clearMessages() {
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('debugInfo').style.display = 'none';
    }

    // 添加回车键提交支持
    document.getElementById('passwd').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
        }
    });
</script>
</body>
</html>